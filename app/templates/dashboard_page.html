{% extends "layout_no_sidebar.html" %}

{% block title %}Dashboard - {{ nome_empresa }}{% endblock %}

{% block content %}
<div id="dashboard-header" class="mb-3 d-flex justify-content-between align-items-center">
    <a href="{{ url_for('fiscal.selecionar_departamento', nome_empresa=nome_empresa, periodo=periodo) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar para Seleção de Departamento
    </a>
    <button id="generate-pdf-btn" class="btn btn-danger btn-sm">
        <i class="bi bi-file-earmark-pdf-fill"></i> Gerar PDF
    </button>
</div>

<div id="dashboard-content">

    {% macro chart_card(title, chart_id, chart_data) %}
    <div class="col">
        <div class="card h-100">
            <div class="card-header py-2 fw-bold">{{ title }}</div>
            <div class="card-body p-2">
                <div class="row align-items-center g-2">
                    <div class="col-md-6 d-flex align-items-center">
                        <div style="position: relative; width: 100%;">
                            <canvas id="{{ chart_id }}"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-hover small mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Subcategoria</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total = chart_data.data | sum %}
                                {% for i in range(chart_data.labels|length) %}
                                <tr>
                                    <td>{{ chart_data.labels[i] }}</td>
                                    <td class="text-end fw-bold">{{ "R$ {:,.2f}".format(chart_data.data[i]).replace(",", "v").replace(".", ",").replace("v", ".") }}</td>
                                    <td class="text-end text-body-secondary">{{ "%.2f"|format((chart_data.data[i] / total * 100) if total > 0 else 0) }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-body-secondary">Sem dados.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endmacro %}

    <div id="capture-page-1">
        <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
            <div>
                <h3><i class="bi bi-pie-chart-fill"></i> Dashboard Unificado: <strong>{{ nome_empresa }}</strong></h3>
                {% if dados_empresa.cnpj %}
                    <h6 class="text-body-secondary fw-normal">{{ dados_empresa.cnpj }}</h6>
                {% endif %}
            </div>
            <span class="badge bg-secondary fs-6">Período: {{ periodo.split('-')[1] }}/{{ periodo.split('-')[0] }}</span>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title"><i class="bi bi-calculator"></i> Resumo Fiscal</h4>
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span class="fs-5">Total Faturamento</span>
                        <span class="fs-5 text-success fw-bold">{{ "R$ {:,.2f}".format(resumo_fiscal.total_faturamento).replace(",", "v").replace(".", ",").replace("v", ".") }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span class="fs-5">Despesas + Custos (DP)</span>
                        <span class="fs-5 text-danger fw-bold">{{ "R$ {:,.2f}".format(resumo_fiscal.total_despesas_e_custos).replace(",", "v").replace(".", ",").replace("v", ".") }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span class="fs-5">Total Impostos (Fiscal + DP)</span>
                        <span class="fs-5 text-warning fw-bold">{{ "R$ {:,.2f}".format(resumo_fiscal.total_impostos).replace(",", "v").replace(".", ",").replace("v", ".") }}</span>
                    </div>
                </div>
            </div>
        </div>

        {% if fiscal_charts %}
        <div class="row row-cols-1 g-4 mb-4">
            {% for chart in fiscal_charts %}
                {% if chart.title in ['Faturamento', 'Despesas', 'Impostos Federais', 'Impostos Estaduais'] %}
                    {{ chart_card(chart.title, chart.id, chart.data) }}
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div id="capture-page-2">
        {% if fiscal_charts %}
        <div class="row row-cols-1 g-4 mb-4 mt-4">
             {% for chart in fiscal_charts %}
                {% if chart.title in ['Impostos Municipais', 'Retenções Federais'] %}
                    {{ chart_card(chart.title, chart.id, chart.data) }}
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% if situacao_colaboradores or (colaboradores | selectattr('status') | list | length > 0) %}
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-3"><i class="bi bi-people-fill"></i> Resumo do Departamento Pessoal</h4>
                {% if situacao_colaboradores %}
                    <p class="fs-6"><strong>Situação Geral:</strong> {{ situacao_colaboradores }}</p>
                    <hr>
                {% endif %}
                <div class="row mt-3">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <h6 class="text-warning"><i class="bi bi-sun-fill"></i> Férias</h6>
                        <ul class="list-group list-group-flush">
                            {% set found = namespace(value=false) %}
                            {% for col in colaboradores if col.status and 'Férias' in col.status %}
                                <li class="list-group-item px-0 py-1">{{ col.nome }} <small class="text-body-secondary">({{ col.status.split(': ')[1] }})</small></li>
                                {% set found.value = true %}
                            {% endfor %}
                            {% if not found.value %}
                                 <li class="list-group-item px-0 py-1 text-body-secondary fst-italic">Nenhum funcionário.</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <h6 class="text-danger"><i class="bi bi-bandaid-fill"></i> Afastados</h6>
                        <ul class="list-group list-group-flush">
                            {% set found = namespace(value=false) %}
                            {% for col in colaboradores if col.status and 'Afastado' in col.status %}
                                <li class="list-group-item px-0 py-1">{{ col.nome }} <small class="text-body-secondary">({{ col.status.split(': ')[1] }})</small></li>
                                {% set found.value = true %}
                            {% endfor %}
                            {% if not found.value %}
                                 <li class="list-group-item px-0 py-1 text-body-secondary fst-italic">Nenhum funcionário.</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-info"><i class="bi bi-person-arms-up"></i> Licença Maternidade</h6>
                        <ul class="list-group list-group-flush">
                            {% set found = namespace(value=false) %}
                            {% for col in colaboradores if col.status and 'Licença Maternidade' in col.status %}
                                <li class="list-group-item px-0 py-1">{{ col.nome }} <small class="text-body-secondary">({{ col.status.split(': ')[1] }})</small></li>
                                {% set found.value = true %}
                            {% endfor %}
                            {% if not found.value %}
                                 <li class="list-group-item px-0 py-1 text-body-secondary fst-italic">Nenhuma funcionária.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if dp_chart %}
        <div class="row g-4 mt-4">
             {{ chart_card(dp_chart.title, dp_chart.id, dp_chart.data) }}
        </div>
        {% endif %}
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw: function(chart) {
            if (chart.config.type === 'doughnut' && chart.config.options.plugins.centerText.enabled) {
                const ctx = chart.ctx;
                const total = chart.config.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const text = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                ctx.save();
                const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                ctx.font = 'bold 0.8rem sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = document.documentElement.dataset.bsTheme === 'dark' ? '#fff' : '#495057';
                ctx.fillText(text, centerX, centerY);
                ctx.restore();
            }
        }
    };
    Chart.register(centerTextPlugin);

    function createDoughnutChart(canvasId, chartData, chartTitle) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const hasData = chartData && chartData.data && chartData.data.length > 0 && chartData.data.some(d => d > 0);
        let palette;
        const lowerCaseTitle = chartTitle.toLowerCase();

        if (lowerCaseTitle.includes('faturamento')) {
            palette = ['#28a745', '#218838', '#1e7e34', '#155724', '#10431b', '#0b2e13'];
        } else if (lowerCaseTitle.includes('despesas')) {
            palette = ['#dc3545', '#c82333', '#bd2130', '#a71d2a', '#921824', '#7c131e'];
        } else if (lowerCaseTitle.includes('impostos')) {
            palette = ['#fd7e14', '#f57302', '#e06800', '#c95e00', '#b35400', '#9c4900'];
        } else if (lowerCaseTitle.includes('retenções') || lowerCaseTitle.includes('pessoal')) {
            palette = ['#6c757d', '#5a6268', '#4e555b', '#3d4246', '#2d3135', '#212529'];
        } else {
            palette = ['#0d6efd', '#0b5ed7', '#0a58ca', '#0951bd', '#084ab5'];
        }

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: hasData ? chartData.labels : ['Sem Dados'],
                datasets: [{
                    data: hasData ? chartData.data : [1],
                    backgroundColor: hasData ? palette : ['#e9ecef'],
                    borderColor: document.documentElement.dataset.bsTheme === 'dark' ? '#343a40' : '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%', 
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: hasData },
                    centerText: { enabled: hasData }
                }
            }
        });
    }

    const fiscalCharts = {{ fiscal_charts | tojson }};
    const dpChart = {{ dp_chart | tojson }};

    fiscalCharts.forEach(chart => {
        if (document.getElementById(chart.id)) {
            createDoughnutChart(chart.id, chart.data, chart.title);
        }
    });

    if (dpChart && document.getElementById(dpChart.id)) {
        createDoughnutChart(dpChart.id, dpChart.data, dpChart.title);
    }

    const pdfButton = document.getElementById('generate-pdf-btn');
    const page1 = document.getElementById('capture-page-1');
    const page2 = document.getElementById('capture-page-2');

    pdfButton.addEventListener('click', async () => {
        pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Iniciando...';
        pdfButton.disabled = true;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        
        const options = {
            // Alterado para '2' para máxima qualidade (HD)
            scale: 2, 
            useCORS: true,
            onclone: (doc) => {
                doc.body.dataset.bsTheme = 'light';
            }
        };

        const addImageToPdf = (canvas, isFirstPage) => {
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = pdfWidth * 0.95;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            const xOffset = (pdfWidth - imgWidth) / 2;
            const yOffset = 10;
            
            if (!isFirstPage) {
                pdf.addPage();
            }
            pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
        };

        pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando Página 1/2...';
        const canvas1 = await html2canvas(page1, options);
        addImageToPdf(canvas1, true);

        pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando Página 2/2...';
        const canvas2 = await html2canvas(page2, options);
        addImageToPdf(canvas2, false);
        
        pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Montando o PDF...';
        
        pdf.save(`dashboard-unificado-{{ nome_empresa }}-{{ periodo }}.pdf`);
        
        pdfButton.innerHTML = '<i class="bi bi-file-earmark-pdf-fill"></i> Gerar PDF';
        pdfButton.disabled = false;
    });
});
</script>
{% endblock %}