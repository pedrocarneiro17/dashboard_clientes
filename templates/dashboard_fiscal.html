{% extends "layout_no_sidebar.html" %}

{% block title %}Dashboard Fiscal - {{ nome_empresa }}{% endblock %}

{% block content %}
<div id="dashboard-header" class="mb-3 d-flex justify-content-between align-items-center">
    <a href="{{ url_for('selecionar_departamento', nome_empresa=nome_empresa, periodo=periodo) }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Voltar para Seleção de Departamento
    </a>
    <!-- Botão para Gerar PDF (agora usa JavaScript) -->
    <button id="generate-pdf-btn" class="btn btn-danger btn-sm">
        <i class="bi bi-file-earmark-pdf-fill"></i> Gerar PDF
    </button>
</div>

<!-- Container para o conteúdo que será exportado -->
<div id="dashboard-content">
    <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
        <div>
            <h3><i class="bi bi-pie-chart-fill"></i> Dashboard Fiscal: <strong>{{ nome_empresa }}</strong></h3>
            <!-- CNPJ ADICIONADO AQUI -->
            {% if dados_empresa.cnpj %}
                <h6 class="text-body-secondary fw-normal">{{ dados_empresa.cnpj }}</h6>
            {% endif %}
        </div>
        <span class="badge bg-secondary fs-6">Período: {{ periodo.split('-')[1] }}/{{ periodo.split('-')[0] }}</span>
    </div>

    <!-- Função Jinja para criar um card de gráfico -->
    {% macro chart_card(title, chart_id, chart_data) %}
    <div class="col">
        <div class="card h-100">
            <div class="card-header">{{ title }}</div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4" style="min-height: 110px;">
                        <div style="position: relative; height: 100%; width: 100%;">
                            <canvas id="{{ chart_id }}"></canvas>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Subcategoria</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total = chart_data.data | sum %}
                                {% for i in range(chart_data.labels|length) %}
                                <tr>
                                    <td>{{ chart_data.labels[i] }}</td>
                                    <td class="text-end fw-bold">{{ "R$ {:,.2f}".format(chart_data.data[i]).replace(",", "v").replace(".", ",").replace("v", ".") }}</td>
                                    <td class="text-end text-body-secondary">{{ "%.2f"|format((chart_data.data[i] / total * 100) if total > 0 else 0) }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-body-secondary">Sem dados.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endmacro %}

    <div class="row row-cols-1 g-4">
        {{ chart_card('Faturamento', 'chartFaturamento', chart_faturamento) }}
        {{ chart_card('Despesas', 'chartDespesas', chart_despesas) }}
        {{ chart_card('Impostos Federais', 'chartImpFederal', chart_imp_federal) }}
        {{ chart_card('Impostos Estaduais', 'chartImpEstadual', chart_imp_estadual) }}
        {{ chart_card('Impostos Municipais', 'chartImpMunicipal', chart_imp_municipal) }}
        {{ chart_card('Retenções Federais', 'chartRetFederal', chart_ret_federal) }}
    </div>
</div>

<!-- Bibliotecas para Geração de PDF e Gráficos -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Plugin para desenhar texto no centro do gráfico de pizza
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw: function(chart) {
            if (chart.config.type === 'doughnut') {
                const ctx = chart.ctx;
                const total = chart.config.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const text = 'R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                ctx.save();
                const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                
                ctx.font = 'bold 0.8rem sans-serif'; // Tamanho da fonte reduzido
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = document.documentElement.dataset.bsTheme === 'dark' ? '#fff' : '#495057';
                ctx.fillText(text, centerX, centerY);
                ctx.restore();
            }
        }
    };
    Chart.register(centerTextPlugin);

    function createDoughnutChart(canvasId, chartData) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const hasData = chartData && chartData.data && chartData.data.length > 0;
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: hasData ? chartData.labels : ['Sem Dados'],
                datasets: [{
                    data: hasData ? chartData.data : [1],
                    backgroundColor: hasData ? undefined : ['#e9ecef'],
                    borderWidth: hasData ? 1 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: hasData }
                }
            }
        });
    }

    createDoughnutChart('chartFaturamento', {{ chart_faturamento | tojson }});
    createDoughnutChart('chartDespesas', {{ chart_despesas | tojson }});
    createDoughnutChart('chartImpFederal', {{ chart_imp_federal | tojson }});
    createDoughnutChart('chartImpEstadual', {{ chart_imp_estadual | tojson }});
    createDoughnutChart('chartImpMunicipal', {{ chart_imp_municipal | tojson }});
    createDoughnutChart('chartRetFederal', {{ chart_ret_federal | tojson }});

    // Lógica para o botão de gerar PDF
    const pdfButton = document.getElementById('generate-pdf-btn');
    const dashboardContent = document.getElementById('dashboard-content');

    pdfButton.addEventListener('click', () => {
        pdfButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gerando...';
        pdfButton.disabled = true;

        html2canvas(dashboardContent, { 
            scale: 2,
            useCORS: true,
            onclone: (document) => {
                document.body.dataset.bsTheme = 'light';
            }
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const ratio = canvasWidth / canvasHeight;
            
            const imgWidth = pdfWidth * 0.70;
            const imgHeight = imgWidth / ratio;
            
            const xOffset = (pdfWidth - imgWidth) / 2;
            const yOffset = 10;

            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', xOffset, yOffset + position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - yOffset);

            while (heightLeft > 0) {
                position -= (pdfHeight - yOffset * 2);
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', xOffset, position + yOffset, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - yOffset * 2);
            }
            
            pdf.save("dashboard-fiscal-{{ nome_empresa }}-{{ periodo }}.pdf");

            pdfButton.innerHTML = '<i class="bi bi-file-earmark-pdf-fill"></i> Gerar PDF';
            pdfButton.disabled = false;
        });
    });
});
</script>
{% endblock %}
